sudo: false

language: cpp

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - cmake
      - libprotobuf-dev
      - protobuf-compiler

  homebrew:
    packages:
      - protobuf

  chocolatey:
    packages:
      - protoc

matrix:
  include:
    - name: "android-armv7-gpu-deploy"
      language: android
      dist: trusty
      components:
        - tools
        - platform-tools
        - tools
        - build-tools-26.0.1
        - android-24
        - extra-android-support
        - extra-android-m2repository
        - sys-img-armeabi-v7a-android-24
      env:
        - BEFORE_BUILD="wget https://sdk.lunarg.com/sdk/download/1.1.92.1/linux/vulkansdk-linux-x86_64-1.1.92.1.tar.gz?Human=true -O vulkansdk-linux-x86_64-1.1.92.1.tar.gz && tar -xf vulkansdk-linux-x86_64-1.1.92.1.tar.gz && wget https://dl.google.com/android/repository/android-ndk-r18b-linux-x86_64.zip && unzip -q android-ndk-r18b-linux-x86_64.zip && (yes | sdkmanager \"platforms;android-24\") && (yes | sdkmanager \"build-tools;26.0.1\") && (echo y | android update sdk -a --no-ui --filter \"android-24\") && (echo y | android update sdk -a --no-ui --filter \"sys-img-armeabi-v7a-android-24\") && (echo no | android create avd --force -n test -t android-24 --abi armeabi-v7a -c 100M) && (emulator -avd test -no-audio -no-window &) && android-wait-for-emulator && (adb shell input keyevent 82 &)"
        - BUILD="export PATH=`pwd`/1.1.92.1/x86_64/bin:$PATH && mkdir build && cd build && cmake -DCMAKE_TOOLCHAIN_FILE=`pwd`/android-ndk-r18b/build/cmake/android.toolchain.cmake -DANDROID_ABI=\"armeabi-v7a\" -DANDROID_ARM_NEON=ON -DANDROID_PLATFORM=android-24 -DNCNN_VULKAN=ON .. && make -j2 && adb shell \"cd /data/local/tmp/ && ls\""

before_install:
  - eval "${BEFORE_BUILD}"

script:
  - eval "${BUILD}"
